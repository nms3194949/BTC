<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>BTC/ETH å›æ’¤é€²å‡ºå ´ç­–ç•¥å›æ¸¬ & å³æ™‚æ—¥ç·šï¼ˆBinanceï¼‰ï½œæ·±è—Ã—é‡‘è‰²ä¸»é¡Œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
  <style>
    :root{
      /* æ·±è—Ã—é‡‘è‰²ä¸»é¡Œ */
      --deep:#0A1221;          /* æ·±è—èƒŒæ™¯ */
      --deep-2:#0C152A;        /* æ¬¡å±¤æ·±è— */
      --deep-3:#0b0f14;        /* èƒŒæ™¯æ”¾å°„æ··è‰² */
      --text:#EDEFF5;          /* ä¸»è¦å­—è‰² */
      --muted:#9AA4B2;         /* æ¬¡è¦æ–‡å­— */
      --line:#1F2937;          /* å†·ç°é‚Šç·š */
      --gold:#C9A227;          /* äº®é‡‘ */
      --gold-soft:#E9D18A;     /* æŸ”é‡‘ */
      --ok:#22C55E;            /* æ­£å‘ */
      --warn:#F59E0B;          /* è­¦ç¤º */
      --bad:#EF4444;           /* é¢¨éšª */
      /* å‡ºå ´è§¸ç™¼åƒ¹çš„æ–°é¡è‰²ï¼ˆä¾‹å¦‚ç´«è‰²ï¼‰ */
      --exit-trigger-color: #A855F7; 
    }

    html{overflow-y:scroll}
    *{box-sizing:border-box}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 70% -10%, #0c1724 0%, var(--deep-3) 55%),
        linear-gradient(180deg, rgba(201,162,39,0.06), rgba(201,162,39,0.0) 45%);
    }

    header{padding:28px 20px 12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
    h1{margin:0 0 6px;font-size:22px;letter-spacing:.3px}
    .sub{color:var(--gold-soft);font-size:13px}

    main{padding:18px;max-width:1280px;margin:0 auto}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
      border:1px solid var(--line);border-radius:14px;padding:16px;
      box-shadow:0 0 0 1px rgba(201,162,39,.06), 0 10px 30px rgba(0,0,0,.25);
    }
    .section-title{font-size:14px;color:var(--muted);margin:0 0 10px;letter-spacing:.2px}

    .controls .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .controls label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .controls input[type=file],.controls input[type=number],.controls select{
      width:100%;background:var(--deep-2);color:var(--text);border:1px solid rgba(201,162,39,.25);
      border-radius:10px;padding:10px 12px;outline:none
    }

    .pill{display:inline-block;padding:2px 8px;font-size:12px;border-radius:999px;border:1px solid rgba(201,162,39,.35);color:var(--gold-soft);background:rgba(201,162,39,.06)}

    /* åƒæ•¸é¢æ¿ - æ‘ºç–Šæ¨£å¼ */
    .collapsible-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 0 0 5px 0;
        border-bottom: 1px dashed var(--line); /* å€éš”ç·š */
    }
    .collapsible-header:hover {
        filter: brightness(1.1);
    }
    .collapsible-content {
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .arrow {
        display: inline-block;
        transition: transform 0.3s;
        font-size: 16px;
        color: var(--gold-soft);
        margin-right: 5px;
    }
    .collapsed .arrow {
        transform: rotate(-90deg);
    }

    /* çµæœè¡¨ */
    table{width:100%;border-collapse:collapse;border-spacing:0;border:1px solid rgba(201,162,39,.30);background:linear-gradient(180deg,rgba(233,209,138,.05),rgba(233,209,138,.02));border-radius:12px;overflow:hidden}
    th,td{
        padding:10px 12px;font-size:13px;
        border-right:1px solid rgba(201,162,39,.22);
    }
    th:last-child, td:last-child {
        border-right: none;
    }
    
    /* æ‘˜è¦è¡¨æ ¼ç‰¹æ®Šæ¨£å¼ */
    #summaryTable1, #summaryTable2 {
        table-layout: fixed; /* è®“æ¬„å¯¬å‡ç­‰ */
        margin-bottom: 0px; 
        border: none;
    }
    #summaryTable1 th, #summaryTable1 td, 
    #summaryTable2 th, #summaryTable2 td {
        white-space: nowrap;
        border: none;
        padding: 8px 10px;
    }
    #summaryTable1 th:last-child, #summaryTable2 th:last-child,
    #summaryTable1 td:last-child, #summaryTable2 td:last-child {
        border-right: none;
    }

    /* ç¢ºä¿æ‰€æœ‰ th éƒ½æœ‰åº•ç·šåˆ†éš” */
    #summaryTable1 thead th, #summaryTable2 thead th {
        border-bottom: 1px solid rgba(201,162,39,.22);
    }
    
    /* æ•¸æ“šè¡Œæ¨£å¼ */
    #summaryTable1 td, #summaryTable2 td {
        text-align: center;
        font-weight: 600;
        color: var(--text);
    }
    
    /* ç¸¾æ•ˆé¡è‰²æ¨™ç±¤ */
    .data-ok { color: var(--ok); }
    .data-bad { color: var(--bad); }
    .data-warn { color: var(--warn); }

    /* ç´…ç¶ ç‡ˆç‡ˆè™Ÿ */
    .traffic-light {
        height: 12px;
        width: 12px;
        background-color: var(--ok); /* Default green */
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        vertical-align: middle;
    }
    .traffic-light.bad {
        background-color: var(--bad); /* Red for liquidated */
    }

    /* AI å»ºè­°å¡ç‰‡æ¨£å¼ */
    #aiSuggestionCard {
        padding: 12px;
        border: 1px solid rgba(201,162,39,.4);
        border-radius: 10px;
        background: rgba(201,162,39,0.05);
    }
    #aiSuggestionCard h4 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 14px;
        color: var(--gold-soft);
        display: flex;
        align-items: center;
    }
    #aiSuggestionCard .advice-type {
        font-weight: bold;
        margin-right: 8px;
        color: var(--ok);
    }
    #aiSuggestionCard .advice-type.bad {
        color: var(--bad);
    }
    #aiSuggestionCard .advice-type.warn {
        color: var(--warn);
    }
    #aiSuggestionCard ul {
        list-style: disc;
        padding-left: 20px;
        margin: 6px 0 0;
        font-size: 13px;
        color: var(--muted);
    }
    /* é€šç”¨è¡¨æ ¼æ¨£å¼ */
    th{
      text-align:left;color:var(--gold-soft);
      background:linear-gradient(180deg,rgba(233,209,138,.08),rgba(233,209,138,.04));
      position:sticky;top:0;backdrop-filter:saturate(120%) blur(2px);
    }
    tbody tr:hover{background:rgba(233,209,138,.06)}

    .footnote{color:var(--muted);font-size:12px;margin-top:8px}
    button{
      background:linear-gradient(180deg,rgba(233,209,138,.16),rgba(233,209,138,.08));
      border:1px solid rgba(201,162,39,.45);border-radius:10px;padding:8px 12px;color:var(--text);cursor:pointer;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 4px 12px rgba(201,162,39,.12);
    }
    button:hover{filter:brightness(1.03)}
    button:disabled{opacity:.5;cursor:not-allowed}

    .scrollbox{max-height:300px;overflow:auto;scrollbar-gutter:stable}
    .hr{height:1px;background:linear-gradient(90deg,rgba(233,209,138,.25),rgba(233,209,138,.05));margin:10px 0}
  
    /* å›æ¸¬çµæœå€å¡Šä½ˆå±€èª¿æ•´ */
    .backtest-results{
        display: flex;
        flex-direction: column;
        gap: 16px; /* å¢åŠ ä¸»è¦å€å¡Šé–“è· */
        padding-top: 0;
    }
    .backtest-results .section-title{
        margin-top: 10px;
        margin-bottom: 0;
    }
  </style>
</head>
<body>
<header>
  <h1>BTC / ETH å›æ’¤é€²å‡ºå ´ç­–ç•¥å›æ¸¬ï¼ˆä¸Šå‚³ï¼‰ + å³æ™‚æ—¥ç·šï¼ˆBinanceï¼‰</h1>
  <div class="sub">æ·±è—Ã—é‡‘è‰²ä¸»é¡Œï¼šå·¦å´ <b>å›æ¸¬æ§åˆ¶</b>ï¼ˆé€²/å‡ºå ´ã€å†é€²å ´ã€å®‰å…¨é‚Šéš›ï¼‰ï¼Œå³å´ <b>å³æ™‚æ—¥ç·šï¼‹æ‘˜è¦å¡ï¼‹æŠ˜ç·šåœ–</b>ï¼›è‰²å½©èˆ‡æ ¼ç·šå·²çµ±ä¸€é‡‘è‰²ç³»ã€‚</div>
</header>

<main class="grid">
  <section class="card controls">
    <h3 class="section-title">è³‡æ–™èˆ‡åƒæ•¸ï¼ˆå›æ¸¬ï¼‰</h3>

    <div class="row">
      <div>
        <label>é¸æ“‡ Excelï¼ˆå«ã€Œæ—¥æœŸã€ã€Œæ”¶å¸‚ã€ï¼‰æˆ– CSV</label>
        <input accept=".xlsx,.xls,.csv" id="file" type="file" />
      </div>
      <div>
        <label>ç‹€æ…‹</label>
        <div class="pill" id="status">ç­‰å¾…é¸æª”</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>æœŸé–“ï¼ˆè¿‘ï¼‰</label>
        <select id="years">
          <option value="1">1 å¹´</option>
          <option value="2" selected>2 å¹´</option>
          <option value="3">3 å¹´</option>
        </select>
      </div>
      <div>
        <label>å¹£åˆ¥</label>
        <select id="symbolBacktest">
          <option value="BTC" selected>BTC</option>
          <option value="ETH">ETH</option>
        </select>
      </div>
    </div>

    <div class="hr"></div>

    <h4 class="section-title">é€²å ´è¨­å®š</h4>
    <div class="row">
      <div>
        <label>æ»¾å‹•é«˜é»è¦–çª—ï¼ˆé€²å ´ï¼‰</label>
        <select id="entryLookback">
          <option value="30">30 å¤©</option>
          <option value="60">60 å¤©</option>
          <option value="90" selected>90 å¤©</option>
          <option value="180">180 å¤©</option>
        </select>
      </div>
      <div>
        <label>å›æª”è§¸ç™¼ï¼ˆ%ï¼‰</label>
        <input id="entryPullback" type="number" min="5" max="30" step="1" value="20" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>æ¯å­£æœ€å¤šé€²å ´æ¬¡æ•¸</label>
        <select id="maxPerQ">
          <option value="1">1 æ¬¡</option>
          <option value="2" selected>2 æ¬¡</option>
          <option value="3">3 æ¬¡</option>
          <option value="4">4 æ¬¡</option>
          <option value="5">5 æ¬¡</option>
        </select>
      </div>
      <div></div>
    </div>

    <div class="hr"></div>

    <h4 class="section-title">å‡ºå ´è¨­å®š</h4>
    <div class="row">
      <div>
        <label>åŸºæº–é«˜é»è¦–çª—ï¼ˆå‡ºå ´ï¼å‰é«˜åŸºæº–ï¼‰</label>
        <select id="exitLookback">
          <option value="30" selected>30 å¤©</option>
          <option value="60">60 å¤©</option>
          <option value="90">90 å¤©</option>
          <option value="180">180 å¤©</option>
        </select>
      </div>
      <div>
        <label>å›è½è§¸ç™¼ï¼ˆ%ï¼‰</label>
        <input id="exitDrawdown" type="number" min="5" max="30" step="1" value="15" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>å‡ºå ´æ¯”ä¾‹ï¼ˆ% å€‰ä½ï¼‰</label>
        <input id="exitSellPct" type="number" min="10" max="100" step="5" value="15" />
      </div>
      <div>
        <label>æ¯å­£æœ€å¤šå‡ºå ´æ¬¡æ•¸</label>
        <select id="maxExitPerQ">
          <option value="1">1 æ¬¡</option>
          <option value="2" selected>2 æ¬¡</option>
          <option value="3">3 æ¬¡</option>
          <option value="4">4 æ¬¡</option>
          <option value="5">5 æ¬¡</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label><input id="exitNonNegRoi" type="checkbox" checked style="vertical-align:middle;margin-right:6px;" />ROI < 0 ä¸å‡ºå ´ï¼ˆä»¥ä¿è­‰é‡‘è¨ˆï¼‰</label>
      </div>
      <div>
        <label><input id="exitAboveAvgOnly" type="checkbox" checked style="vertical-align:middle;margin-right:6px;" />å‡ºå ´åƒ¹ä½æ–¼å€‰ä½å‡åƒ¹ä¸å‡ºå ´</label>
      </div>
    </div>

    <div class="hr"></div>

    <div class="collapsible-header" data-target="controlRisk">
        <h4 class="section-title" style="margin:0;">é¢¨æ§</h4>
        <span class="arrow">â–¼</span>
    </div>
    <div id="controlRisk" class="collapsible-content">
        <div class="row">
          <div>
            <label>å®‰å…¨é‚Šéš›ï¼ˆ%ï¼‰</label>
            <input id="safetyFloor" type="number" min="1" max="50" step="1" value="10" />
          </div>
          <div>
            <label>æ˜¯å¦å•Ÿç”¨å®‰å…¨é‚Šéš›</label>
            <select id="safetyMode">
              <option value="on" selected>å•Ÿç”¨ï¼ˆæ¬¡æ—¥æ”¶ç›¤å…¨å‡ºï¼‰</option>
              <option value="off">ä¸ä½¿ç”¨</option>
            </select>
          </div>
        </div>
    </div>
    
    <div class="hr"></div>

    <div class="collapsible-header" data-target="controlFund">
        <h4 class="section-title" style="margin:0;">è³‡é‡‘åƒæ•¸</h4>
        <span class="arrow">â–¼</span>
    </div>
    <div id="controlFund" class="collapsible-content">
        <div class="row">
          <div>
            <label>å›ºå®šä¿è­‰é‡‘ (USD)</label>
            <input id="margin" type="number" min="100" step="100" value="3000" />
          </div>
          <div>
            <label>å–®æ¬¡é€²å ´åç›® (USD)</label>
            <input id="lot" type="number" min="100" step="100" value="6000" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>æ§“æ¡¿ä¸Šé™ (Ã—)</label>
            <input id="lev" type="number" min="1" max="100" step="1" value="20" />
          </div>
          <div>
            <label style="color:var(--gold)">æ»¿å€‰ä¸Šé™ï¼ˆè‡ªå‹•ï¼‰</label>
            <input id="maxNotional" type="number" value="60000" disabled />
          </div>
        </div>
    </div>

    <div class="footnote">
      å›æ¸¬ä»¥<b>æ—¥æ”¶ç›¤</b>åˆ¤å®šï¼ˆä¸çœ‹å½±ç·šï¼‰ã€‚å ±é…¬ä»¥<b>ä¿è­‰é‡‘ç‚ºåŸºæº–</b>ï¼›è‹¥ä»»ä¸€æ—¥æ·¨å€¼ â‰¤ 0 è¦–ç‚ºçˆ†å€‰ï¼ˆROI = -100%ï¼‰ã€‚
    </div>
  </section>

  <section class="card" id="resultCard">
    <section class="card" style="margin-bottom:14px;">
      <h3 class="section-title">
        å³æ™‚æ—¥ç·šï¼ˆBinance
        <select id="symbol" style="background:var(--deep-2);color:var(--text);border:1px solid rgba(201,162,39,.35);border-radius:8px;padding:4px 8px;margin-left:6px;">
          <option value="BTCUSDT" selected>BTC/USDT</option>
          <option value="ETHUSDT">ETH/USDT</option>
        </select>
        ï¼Œå€é–“
        <select id="range" style="background:var(--deep-2);color:var(--text);border:1px solid rgba(201,162,39,.35);border-radius:8px;padding:4px 8px;margin-left:6px;">
          <option value="1M">è¿‘ 1 å€‹æœˆ</option>
          <option value="3M" selected>è¿‘ 3 å€‹æœˆ</option>
          <option value="6M">è¿‘ 6 å€‹æœˆ</option>
          <option value="1Y">è¿‘ 1 å¹´</option>
          <option value="3Y">è¿‘ 3 å¹´</option>
          <option value="ALL">å…¨éƒ¨</option>
        </select>
        ï¼‰
      </h3>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:8px;">
        <div class="metric"><div class="k">ç¾åƒ¹</div><div class="v" id="live_price">â€”</div></div>
        <div class="metric"><div class="k">è¿‘ N æ—¥é«˜é»ï¼ˆé€²å ´ï¼‰</div><div class="v" id="live_rh">â€”</div></div>
        <div class="metric"><div class="k">è§¸ç™¼åƒ¹ï¼ˆé€²å ´ï¼‰</div><div class="v" id="live_trigger">â€”</div></div>
        <div class="metric"><div class="k">è¿‘ M æ—¥æ»¾å‹•é«˜é»ï¼ˆå‡ºå ´ï¼‰</div><div class="v" id="live_rh_exit">â€”</div></div>
        <div class="metric"><div class="k">è§¸ç™¼åƒ¹ï¼ˆå‡ºå ´ï¼‰</div><div class="v" id="live_trigger_exit">â€”</div></div>
      </div>
      <div class="chart-wrap"><canvas id="liveChart"></canvas></div>
      <div class="footnote" id="live_note">èªªæ˜ï¼šä»¥ Binance 1D K ç·šè¨ˆç®—æ»¾å‹•é«˜é»ï¼ˆ<b>ä¸å«ç•¶æ—¥</b>ï¼‰ã€‚ç¾åƒ¹ä»¥ WebSocket ç§’ç´šæ›´æ–°ã€‚</div>
    </section>
    
    <div class="backtest-results">
        <h3 class="section-title">å›æ¸¬çµæœï¼ˆä¸Šå‚³æª”ï¼‰</h3>
        
        <div style="display: flex; flex-direction: column; gap: 10px; padding: 0 6px;">
            <table id="summaryTable1">
                <thead></thead>
                <tbody></tbody>
            </table>
            <table id="summaryTable2">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div id="aiSuggestionCard" style="padding: 12px 16px; margin: 0 6px;">
            <h4>AI åƒæ•¸èª¿æ•´å»ºè­°</h4>
            <div id="aiAdviceContent">è«‹å…ˆä¸Šå‚³æª”æ¡ˆä¸¦åŸ·è¡Œå›æ¸¬ä»¥ç²å¾—å»ºè­°ã€‚</div>
        </div>
        
        <div class="chart-wrap"><canvas id="chart"></canvas></div>
    
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:0 6px 10px;">
          <button id="exportEntries" disabled>ä¸‹è¼‰é€²å‡ºå ´ç´€éŒ„ CSV</button>
          <button id="exportSummary" disabled>ä¸‹è¼‰æ‘˜è¦ CSV</button>
          <button id="exportChartPng" disabled>ä¸‹è¼‰çµæœ PNG (åœ–è¡¨+ç´€éŒ„)</button>
        </div>
    
        <div>
          <div class="section-title" style="margin-bottom:6px;">é€²å‡ºå ´ç´€éŒ„</div>
          <div class="scrollbox" id="entriesScrollbox">
            <table id="entriesTable"><thead><tr></tr></thead><tbody></tbody></table>
          </div>
        </div>
    </div>
  </section>
</main>

<script>
  /* === å…±ç”¨å·¥å…· === */
  const $ = s => document.querySelector(s);
  const iso = d => new Date(d).toISOString().slice(0,10);
  const fmt = (n,d=2)=> (n==null||isNaN(n))?'â€”':Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
  function uiLog(msg){ const el=$('#status'); if(el) el.textContent=msg; }

  /* === å³æ™‚æ—¥ç·šï¼šBinance 1D + WebSocketï¼Œæ”¯æ´é€²/å‡ºå ´é›™è§¸ç™¼ç·š === */
  let liveChart, ws=null, lastLivePrice=null, liveData=[], liveDataFull=[];
  let currentSymbol='BTCUSDT', lastWSUpdate=0;
  let liveRH_entry=null, liveTrigger_entry=null;
  let liveRH_exit=null, liveTrigger_exit=null;

  // ä¸»é¡Œè‰² for Chartsï¼ˆæ·±è—Ã—é‡‘è‰²ï¼‰
  const cPrice = '#EDEFF5';          // æ”¶ç›¤ä¸»ç·š
  const cAvg   = '#E9D18A';          // å¹³å‡åƒ¹ï¼ˆé‡‘è‰²ï¼‰
  const cLiq   = '#EF4444';          // çˆ†å€‰ç·šï¼ˆç´…ï¼‰
  const cEntry = '#22C55E';          // é€²å ´é»ï¼ˆç¶ ï¼‰
  const cExit  = '#F59E0B';          // å‡ºå ´é»ï¼ˆæ©˜ï¼‰
  const cRH    = 'rgba(233,209,138,.85)'; // RH ç·šï¼ˆæ·¡é‡‘ï¼‰
  const cTrigger = 'rgba(201,162,39,.85)';// è§¸ç™¼ç·šï¼ˆäº®é‡‘ï¼‰
  // å‡ºå ´è§¸ç™¼ç·šçš„é¡è‰²ï¼ˆç´«è‰²ï¼‰
  const cTriggerExit = '#A855F7';    


  async function fetchBinanceKlines(symbol, limitDays){
    const url = `https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(symbol)}&interval=1d&limit=${limitDays}`;
    const r = await fetch(url); if(!r.ok) throw new Error('Binance Kç·šæŠ“å–å¤±æ•—ï¼šHTTP '+r.status);
    const arr = await r.json();
    return arr.map(k=>({ time:new Date(k[0]), close:Number(k[4]) }));
  }
  function getRangeDays(code){ switch(code){case '1M':return 31;case '3M':return 93;case '6M':return 186;case '1Y':return 366;case '3Y':return 366*3+5;case 'ALL':return 1500;default:return 93;} }
  function calcRollingHigh(data, N){
    if(!data.length) return {rh:null};
    const lastIdx = data.length-2; if(lastIdx<0) return {rh:null};
    const start = Math.max(0, lastIdx-(N-1));
    let rh=-Infinity; for(let i=start;i<=lastIdx;i++){ if(data[i].close>rh) rh=data[i].close; }
    return { rh: isFinite(rh)?rh:null };
  }
  function renderLiveChart(){
    if(typeof Chart==='undefined') return; const ctx=$('#liveChart').getContext('2d');
    const labels = liveData.map(x=> iso(x.time));
    const price  = liveData.map(x=> x.close);
    
    // æ¢å¾©RHé€²å ´ç·šï¼Œä¸¦æ›´å
    const rhIn   = (liveRH_entry!=null)? labels.map(_=> liveRH_entry): labels.map(_=> null);
    const triIn  = (liveTrigger_entry!=null)? labels.map(_=> liveTrigger_entry): labels.map(_=> null);
    
    // ç§»é™¤RHå‡ºå ´ç·š
    const triOut = (liveTrigger_exit!=null)? labels.map(_=> liveTrigger_exit): labels.map(_=> null);
    const mkt    = (lastLivePrice!=null)? labels.map(_=> lastLivePrice): labels.map(_=> null);

    if(liveChart) liveChart.destroy();
    liveChart = new Chart(ctx,{
      type:'line',
      data:{ labels,
        datasets:[
          { label:`${currentSymbol} æ”¶ç›¤(1D)`, data:price, pointRadius:0, borderColor:cPrice },
          { label:'è¿‘ N æ—¥é«˜é»', data:rhIn, borderDash:[6,4], pointRadius:0, borderColor:cRH }, // ã€åç¨±è®Šæ›´ã€‘
          { label:'è§¸ç™¼åƒ¹ï¼ˆé€²å ´ï¼‰', data:triIn, borderDash:[3,3], pointRadius:0, borderColor:cTrigger },
          { label:'è§¸ç™¼åƒ¹ï¼ˆå‡ºå ´ï¼‰', data:triOut, borderDash:[3,3], pointRadius:0, borderColor:cTriggerExit }, // ã€é¡è‰²è®Šæ›´ã€‘
          { label:'å³æ™‚ç¾åƒ¹', data:mkt, borderDash:[1,1], pointRadius:0, borderColor:'#7dd3fc' }
        ]
      },
      options:{
        responsive:true, resizeDelay:200, animation:false,
        interaction:{mode:'index',intersect:false},
        plugins:{
          legend:{position:'top', labels:{color:'#EDEFF5'}},
          tooltip:{callbacks:{label:(c)=> c.dataset.label+': '+fmt(c.parsed.y,2)}}
        },
        scales:{
          x:{ticks:{color:'#C9D3EA', maxRotation:0,autoSkip:true,maxTicksLimit:12}, grid:{color:'rgba(233,209,138,.12)'}},
          y:{beginAtZero:false, ticks:{color:'#C9D3EA'}, grid:{color:'rgba(233,209,138,.12)'}}
        }
      }
    });
  }
  function updateLiveInfoUI(){
    $('#live_price').textContent = (lastLivePrice!=null)? lastLivePrice.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
    // æ›´æ–° RH é€²å ´åç¨±
    $('#live_rh').textContent    = (liveRH_entry!=null)? liveRH_entry.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
    $('#live_trigger').textContent = (liveTrigger_entry!=null)? liveTrigger_entry.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
    $('#live_rh_exit').textContent = (liveRH_exit!=null)? liveRH_exit.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
    $('#live_trigger_exit').textContent = (liveTrigger_exit!=null)? liveTrigger_exit.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
  }
  async function refreshLiveDaily(){
    try{
      const N_in  = Number($('#entryLookback').value);
      const ddIn  = Number($('#entryPullback').value)/100;
      const N_out = Number($('#exitLookback').value);
      const ddOut = Number($('#exitDrawdown').value)/100;
      const rangeCode = $('#range') ? $('#range').value : '3M';
      const rangeDays = getRangeDays(rangeCode);
      const need = (rangeCode==='ALL')?1500:Math.min(1500, rangeDays + Math.max(N_in,N_out) + 10);
      const rows = await fetchBinanceKlines(currentSymbol, need);
      liveDataFull = rows;
      // RHï¼ˆä¸å«ç•¶æ—¥ï¼‰
      liveRH_entry = calcRollingHigh(liveDataFull, N_in).rh;
      liveTrigger_entry = (liveRH_entry!=null)? liveRH_entry*(1-ddIn): null;
      liveRH_exit  = calcRollingHigh(liveDataFull, N_out).rh;
      liveTrigger_exit = (liveRH_exit!=null)? liveRH_exit*(1-ddOut): null;
      // é¡¯ç¤ºå€é–“
      if(rangeCode==='ALL'){ liveData = liveDataFull.slice(); }
      else { const cut=Math.min(rangeDays, liveDataFull.length); liveData = liveDataFull.slice(liveDataFull.length-cut); }
      if(lastLivePrice==null && liveDataFull.length){ lastLivePrice = liveDataFull[liveDataFull.length-1].close; }
      updateLiveInfoUI(); renderLiveChart();
      $('#live_note').textContent = `å·²è¼‰å…¥ ${currentSymbol} çš„ Binance 1D K ç·šï¼ˆå€é–“ï¼š${rangeCode}ï¼‰ã€‚è¿‘ N/M æ—¥ RH ä¸å«ç•¶æ—¥ï¼›WS ç§’ç´šæ›´æ–°ç¾åƒ¹ã€‚`;
    }catch(err){ console.error(err); $('#live_note').textContent='ç„¡æ³•è¼‰å…¥ Binance K ç·šï¼ˆå¯èƒ½ç¶²è·¯æˆ– CORSï¼‰ã€‚'; }
  }
  function startBinanceWS(){ stopBinanceWS(); try{
    const stream = `${currentSymbol.toLowerCase()}@miniTicker`;
    ws = new WebSocket(`wss://stream.binance.com:9443/ws/${stream}`);
    ws.onmessage = (ev)=>{ try{ const msg=JSON.parse(ev.data); const p=Number(msg.c); if(isFinite(p)){ lastLivePrice=p; updateLiveInfoUI();
      const now=Date.now(); if(liveChart && (now-lastWSUpdate)>=250){ lastWSUpdate=now; const idx=liveChart.data.datasets.findIndex(d=>d.label==='å³æ™‚ç¾åƒ¹'); if(idx>=0){ const len=liveChart.data.labels.length; liveChart.data.datasets[idx].data = Array(len).fill(p); liveChart.update('none'); } } } }catch(_){} };
  }catch(_){} }
  function stopBinanceWS(){ if(ws){ try{ws.close();}catch(_){} ws=null; } }
  function bindLiveAutoRefresh(){ setInterval(refreshLiveDaily, 5*60*1000); }
  async function initLiveModule(){ await refreshLiveDaily(); startBinanceWS(); bindLiveAutoRefresh(); }
  $('#symbol').addEventListener('change', async (e)=>{ currentSymbol=e.target.value||'BTCUSDT'; lastLivePrice=null; await refreshLiveDaily(); startBinanceWS(); });
  $('#range').addEventListener('change', async ()=>{ await refreshLiveDaily(); if(liveChart&& lastLivePrice!=null){ const idx=liveChart.data.datasets.findIndex(d=>d.label==='å³æ™‚ç¾åƒ¹'); if(idx>=0){ const len=liveChart.data.labels.length; liveChart.data.datasets[idx].data = Array(len).fill(lastLivePrice); liveChart.update('none'); } } });

  /* === ä¸Šå‚³å›æ¸¬ === */
  window.addEventListener('error',(e)=>{ const el=$('#status'); if(el) el.textContent='éŒ¯èª¤ï¼š'+(e.message||e.error||e.filename||'æœªçŸ¥éŒ¯èª¤'); });
  let df=null, chart, lastRes=null, lastData=null, lastYears=null;

  function toCSV(rows, headerKeys, headerNames){
    const esc = v=>{ const s=(v==null)?'':String(v); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"': s; };
    const lines=[]; if(headerNames&&headerNames.length) lines.push(headerNames.map(esc).join(','));
    for(const r of rows){ const line = headerKeys.map(k=> esc(typeof k==='function'? k(r): r[k])); lines.push(line.join(',')); }
    return '\uFEFF'+lines.join('\n');
  }
  function downloadCSV(filename, csvString){ const blob=new Blob([csvString],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },0); }
  
  // ä½¿ç”¨ html2canvas æˆªåœ–æ•´å€‹å›æ¸¬çµæœå€ï¼ŒåŒ…æ‹¬åœ–è¡¨å’Œè¡¨æ ¼
  async function exportChartPng(){
    if(!lastRes) return;
    
    // 1. æš«æ™‚å±•é–‹è¡¨æ ¼ï¼ˆç§»é™¤æ²å‹•é™åˆ¶ï¼Œè®“ html2canvas æˆªåœ–æ‰€æœ‰å…§å®¹ï¼‰
    const scrollbox = $('#entriesScrollbox');
    const originalMaxHeight = scrollbox.style.maxHeight;
    const originalOverflow = scrollbox.style.overflow;
    scrollbox.style.maxHeight = 'none'; // å–æ¶ˆé«˜åº¦é™åˆ¶
    scrollbox.style.overflow = 'visible';
    
    // 2. æˆªåœ–ç›®æ¨™å€å¡Š
    const targetElement = $('#resultCard'); 
    
    try {
        const canvas = await html2canvas(targetElement, {
            scale: 2, // æé«˜è§£æåº¦
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#0A1221' // ç¢ºä¿èƒŒæ™¯è‰²æ­£ç¢º
        });

        // 3. æ¢å¾©è¡¨æ ¼æ²å‹•è¨­å®š
        scrollbox.style.maxHeight = originalMaxHeight;
        scrollbox.style.overflow = originalOverflow;

        // 4. è§¸ç™¼ä¸‹è¼‰
        const dataURL = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = `backtest_result_${iso(new Date())}.png`;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ document.body.removeChild(a); }, 0);

    } catch (error) {
        // æ¢å¾©è¡¨æ ¼æ²å‹•è¨­å®šä»¥é˜²è¬ä¸€
        scrollbox.style.maxHeight = originalMaxHeight;
        scrollbox.style.overflow = originalOverflow;
        console.error('PNG æˆªåœ–å¤±æ•—:', error);
        alert('PNG æˆªåœ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¡¨æ ¼å…§å®¹ã€‚');
    }
  }

  async function readAnyTabular(file){ const name=(file.name||'').toLowerCase(); if(name.endsWith('.csv')){ if(typeof XLSX==='undefined') throw new Error('SheetJS æœªè¼‰å…¥'); const text=await file.text(); const wb=XLSX.read(text,{type:'string'}); const ws=wb.Sheets[wb.SheetNames[0]]; if(!ws) throw new Error('æ‰¾ä¸åˆ°ç¬¬ä¸€å€‹å·¥ä½œè¡¨'); const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:false}); return rows;} else { if(typeof XLSX==='undefined') throw new Error('SheetJS æœªè¼‰å…¥'); const ab=await file.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; if(!ws) throw new Error('æ‰¾ä¸åˆ°ç¬¬ä¸€å€‹å·¥ä½œè¡¨'); const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true}); return rows; } }
  function pickCol(headers,candidates){ const map={}; headers.forEach((h,i)=> map[String(h||'').trim()]=i); for(const c of candidates) if(map[c]!=null) return map[c]; const lower={}; headers.forEach((h,i)=> lower[String(h||'').trim().toLowerCase()]=i); for(const c of candidates){ const k=String(c).toLowerCase(); if(lower[k]!=null) return lower[k]; } return -1; }
  function toNumberClean(v){ if(v==null||v==='') return NaN; if(typeof v==='number') return v; if(typeof v==='string'){ const s=v.replace(/,/g,'').trim(); return Number(s); } return Number(v); }
  function parseRows(rows){ if(!rows||!rows.length) throw new Error('å·¥ä½œè¡¨æ²’æœ‰è³‡æ–™'); const headers=rows[0].map(x=> String(x||'').trim()); const dateIdx=pickCol(headers,['æ—¥æœŸ','date','Date','DATE','æ™‚é–“','Time','Datetime']); const closeIdx=pickCol(headers,['æ”¶å¸‚','æ”¶ç›¤','æ”¶ç›¤åƒ¹','Close','close','Adj Close','Adj close','æ”¶ç›¤åƒ¹(USD)']); if(dateIdx===-1||closeIdx===-1) throw new Error('æ‰¾ä¸åˆ°æ¬„ä½ï¼ˆéœ€ã€Œæ—¥æœŸã€ã€Œæ”¶å¸‚ã€ï¼‰'); const out=[]; for(let i=1;i<rows.length;i++){ const r=rows[i]; if(!r) continue; const d=r[dateIdx]; const c=r[closeIdx]; if(d==null||c==null||c==='') continue; let dt; if(typeof d==='number'){ dt=new Date(Math.round((d-25569)*86400*1000)); } else { dt=new Date(d); } const close=toNumberClean(c); if(!isNaN(dt.getTime())&&isFinite(close)) out.push({date:dt, close}); } out.sort((a,b)=> a.date-b.date); return out; }
  function filterYears(data, years){ if(!data.length) return []; const end=data[data.length-1].date; const start=new Date(end); start.setFullYear(start.getFullYear()-years); return data.filter(x=> x.date>=start && x.date<=end); }
  function rollingHighPrevWithIdx(arr, win){
    const n=arr.length; const highs=new Array(n).fill(null); const idxs=new Array(n).fill(null);
    const dq=[];
    for(let i=0;i<n;i++){
      const left=i-win;
      while(dq.length && dq[0]<left) dq.shift();
      highs[i] = dq.length? arr[dq[0]]: null;
      idxs[i]  = dq.length? dq[0]    : null;
      while(dq.length && arr[dq[dq.length-1]] <= arr[i]) dq.pop();
      dq.push(i);
    }
    return {highs, idxs};
  }
  function quarterKey(d){ const y=d.getFullYear(); const q=Math.floor(d.getMonth()/3)+1; return y+'-Q'+q; }

  // === æ–°ç‰ˆæ¨¡æ“¬ï¼šå«é€²å ´ã€å‡ºå ´ï¼ˆéƒ¨åˆ†è³£ï¼‰ã€å†é€²å ´ã€å¯é¸å®‰å…¨é‚Šéš›ï¼›ä»¥æ”¶ç›¤åˆ¶ ===
  function simulate(data, params){
    const prices=data.map(x=> x.close);
    const {highs: prevHighEntry, idxs: prevHighEntryIdx} = rollingHighPrevWithIdx(prices, params.entryLookback);
    const {highs: prevHighExit,  idxs: prevHighExitIdx}  = rollingHighPrevWithIdx(prices, params.exitLookback);

    const entries=[]; // è¨˜éŒ„é€²/å‡ºäº‹ä»¶
    const path = data.map(x=> ({ æ—¥æœŸ:x.date, æ”¶å¸‚:x.close, avg_price:NaN, position_btc:0, equity:params.margin, liq_price:null, safetyPct:null }));

    const maxNotional = params.leverage * params.margin;
    let cumNotional=0, posBTC=0, avgPrice=NaN, realized=0; // realized for partial exits
    let perQ={}, perQExit={}, nEntry=0, nExit=0, liquidated=false, mdd=0, peakEquity=-1e18, pendingForce=false;
    // ç”¨æ–¼è¿½è¹¤ä¸Šä¸€æ¬¡å‰µä¸‹çš„ M æ—¥é«˜é»ï¼ˆç”¨æ–¼è·Œç ´å‰é«˜å‡ºå ´é‚è¼¯ï¼‰
    let lastPeakPrice = -1; 

    for(let i=0;i<data.length;i++){
      if(liquidated) break;
      const p = prices[i];
      const qk = quarterKey(data[i].date);

      // 0) è‹¥æœ‰å¼·åˆ¶å‡ºæ¸…æ’ç¨‹ï¼Œä»Šæ—¥æ”¶ç›¤å…ˆåŸ·è¡Œ
      if(pendingForce && posBTC>0){ realized += posBTC * (p - avgPrice); posBTC=0; avgPrice=NaN; cumNotional=0; pendingForce=false; nExit++; entries.push({ é¡å‹:'å¼·åˆ¶å…¨å‡º', æ—¥æœŸ:data[i].date, åƒ¹æ ¼:p, æ¯”ä¾‹:100 }); }

      // 1) çˆ†å€‰åˆ¤å®šï¼ˆä»¥æ”¶ç›¤ã€å«å·²å¯¦ç¾æç›Šï¼‰
      const equityNow = realized + (isFinite(avgPrice)? (p-avgPrice)*posBTC: 0) + params.margin;
      if(equityNow <= 0){ liquidated=true; entries.push({ é¡å‹:'çˆ†å€‰', æ—¥æœŸ:data[i].date, åƒ¹æ ¼:p, æ¯”ä¾‹:100 }); break; }

      // 2) å‡ºå ´è¦å‰‡
      const phOut = prevHighExit[i];
      const phOutIdx = prevHighExitIdx[i];
      const phOutDate = (phOutIdx!=null && phOutIdx>=0)? data[phOutIdx].date : null;

      let isExitTriggered = false;
      let exitReason = '';
      let triggerPrice = null; // è¨˜éŒ„è§¸ç™¼åƒ¹æ ¼ï¼Œç”¨æ–¼è¨˜éŒ„

      if(posBTC>0){
        // æ¢ä»¶ A: åŸæœ‰çš„ã€Œå›è½è§¸ç™¼ã€
        if(isFinite(phOut) && phOut!=null){
          const triggerOut = phOut * (1 - params.exitDrawdown);
          if(p <= triggerOut){
            isExitTriggered = true;
            exitReason = `å›è½è§¸ç™¼${(params.exitDrawdown*100).toFixed(0)}%`;
            triggerPrice = triggerOut;
          }
        }
        
        // æ¢ä»¶ B: è·Œç ´å‰é«˜è§¸ç™¼
        // è‹¥å·²æœ‰è¿½è¹¤é«˜é»ï¼Œä¸”æ”¶ç›¤åƒ¹è·Œç ´è©²è¿½è¹¤é«˜é»ï¼Œå‰‡è§¸ç™¼
        if(lastPeakPrice > 0 && p < lastPeakPrice){
          isExitTriggered = true;
          exitReason = `è·Œç ´å‰é«˜(${params.exitLookback}æ—¥æ–°é«˜åƒ¹)`;
          triggerPrice = lastPeakPrice;
        }
      }

      if(isExitTriggered && posBTC>0){ // åªè¦ A æˆ– B æ»¿è¶³ï¼Œå³é€²å…¥å‡ºå ´æµç¨‹
        const usedExit = perQExit[qk] || 0;
        const roiGate = params.exitNonNegRoi ? (equityNow - params.margin >= 0) : true;
        
        // ä¿ç•™çš„é™åˆ¶ï¼šå‡ºå ´åƒ¹ä½æ–¼å€‰ä½å‡åƒ¹ä¸å‡ºå ´
        const avgGate = params.exitAboveAvgOnly ? (!isFinite(avgPrice) || p >= avgPrice) : true;
        
        if(usedExit < params.exitMaxPerQuarter && roiGate && avgGate){
          const sellFrac = Math.min(1, Math.max(0, params.exitSellPct/100));
          const sellBTC  = posBTC * sellFrac;
          
          if(sellBTC>0){
            realized += sellBTC * (p - avgPrice);
            posBTC  -= sellBTC;
            // é‡æ–°è¨ˆç®— cumNotional (å‡è¨­ç­‰æ¯”ä¾‹æ¸›å°‘)
            cumNotional = (posBTC>0)? cumNotional * (posBTC / (posBTC + sellBTC)): 0;
            
            perQExit[qk] = usedExit + 1; nExit++;
            const equityAfterExit = realized + (isFinite(avgPrice)? (p-avgPrice)*posBTC:0) + params.margin;
            const notionalAfterExit = posBTC * p;
            const levXExit = (equityAfterExit>0)? (notionalAfterExit/equityAfterExit) : null;
            
            entries.push({ 
                é¡å‹: exitReason + ` (${Math.round(params.exitSellPct)}%)`, 
                æ—¥æœŸ:data[i].date, åƒ¹æ ¼:p, åƒè€ƒé«˜é»: phOut, åƒè€ƒé«˜é»æ—¥æœŸ: phOutDate, è§¸ç™¼åƒ¹: triggerPrice, 
                åç›®éƒ¨ä½USD: -sellBTC * p, ç´¯ç©åç›®USD: cumNotional, å€‰ä½å‡åƒ¹: avgPrice, æŒå€‰åƒ¹å€¼USD: notionalAfterExit, å‡ºå ´æ¯”ä¾‹: Math.round(params.exitSellPct), ROI_USDT: (equityAfterExit - params.margin), ROI_PCT: (equityAfterExit/params.margin - 1) * 100, å€‰ä½æ§“æ¡¿å€æ•¸: levXExit 
            });
            if(posBTC===0){ avgPrice=NaN; lastPeakPrice = -1; }
          }
        }
      }

      // 3) é€²å ´ï¼ˆå¯åœ¨è³£å‡ºå¾Œå†åˆ¤æ–·ï¼‰
      const phIn = prevHighEntry[i];
      const phInIdx = prevHighEntryIdx[i];
      const phInDate = (phInIdx!=null && phInIdx>=0)? data[phInIdx].date : null;
      if(isFinite(phIn) && phIn!=null){
        const triggerIn = phIn * (1 - params.entryPullback);
        const used = perQ[qk]||0;
        if(p <= triggerIn && cumNotional < maxNotional && used < params.maxPerQuarter){
          const addNotional = Math.min(params.lotUSD, maxNotional - cumNotional);
          if(addNotional>0){
            const addBTC = addNotional / p;
            const newPos = posBTC + addBTC;
            const newAvg = (posBTC>0)? (avgPrice*posBTC + p*addBTC)/newPos : p;
            avgPrice=newAvg; posBTC=newPos; cumNotional += addNotional; perQ[qk]=used+1; nEntry++;
            const levX = (params.margin + (p-newAvg)*newPos)>0 ? (newPos*p) / (params.margin + (p-newAvg)*newPos) : null;
            const equityAfterEntry = (params.margin + (p - newAvg)*newPos) + realized; const notionalAfterEntry = newPos * p; 
            entries.push({ é¡å‹:'é€²å ´', æ—¥æœŸ:data[i].date, åƒ¹æ ¼:p, åƒè€ƒé«˜é»: phIn, åƒè€ƒé«˜é»æ—¥æœŸ: phInDate, è§¸ç™¼åƒ¹: triggerIn, åç›®éƒ¨ä½USD:addNotional, ç´¯ç©åç›®USD:cumNotional, å€‰ä½å‡åƒ¹:newAvg, æŒå€‰åƒ¹å€¼USD:notionalAfterEntry, ROI_USDT:(equityAfterEntry - params.margin), ROI_PCT:(equityAfterEntry/params.margin - 1) * 100, å€‰ä½æ§“æ¡¿å€æ•¸:levX });
          }
        }
      }
      
      // æ›´æ–°æœ€å¾Œé«˜é»ç‹€æ…‹ (Mæ—¥é«˜é»)
      if (isFinite(phOut) && phOut!=null && p > phOut) {
          // ç•¶å‰æ”¶ç›¤åƒ¹çªç ´ M æ—¥é«˜é»ï¼Œæ›´æ–°è¿½è¹¤é«˜é»
          lastPeakPrice = p; 
      }
      // å¦‚æœæ²’æœ‰å€‰ä½ï¼Œé‡ç½®è¿½è¹¤é«˜é»
      if(posBTC === 0){
          lastPeakPrice = -1;
      }

      // 4) è¨˜éŒ„æ¯æ—¥è·¯å¾‘ã€è¨ˆç®—å®‰å…¨é‚Šéš› & MDD
      const equity = realized + (isFinite(avgPrice)? (p-avgPrice)*posBTC:0) + params.margin;
      const liq = (posBTC>0 && isFinite(avgPrice))? (avgPrice - (params.margin/posBTC)) : null; // Equity=0 â†’ P=avg - margin/pos
      path[i].avg_price = avgPrice; path[i].position_btc = posBTC; path[i].equity = equity; path[i].liq_price = liq;
      path[i].safetyPct = (liq!=null)? ((p - liq)/p*100) : null;

      if(equity > peakEquity) peakEquity = equity;
      const dd = peakEquity - equity; if(dd > mdd) mdd = dd;

      // 5) å®‰å…¨é‚Šéš›é–€æª»ï¼ˆè‹¥å•Ÿç”¨ï¼‰ï¼šå°æ–¼é–€æª» â†’ æ’ç¨‹ã€Œæ¬¡æ—¥æ”¶ç›¤ã€å…¨å‡º
      if(params.safetyOn && posBTC>0 && path[i].safetyPct!=null && path[i].safetyPct < params.safetyFloorPct){ pendingForce = true; }
    }

    // æ”¶å°¾
    const equityEnd = liquidated ? 0 : path[path.length-1].equity;
    const roi = liquidated ? -1 : (equityEnd/params.margin - 1);
    const mddPct = mdd / params.margin * 100;
    const safetyEnd = path[path.length-1].safetyPct;

    return { entries, path, liquidated, roi, equityEnd, mddPct, nEntry, nExit, safetyEnd };
  }

  // ã€ä¿®æ”¹å‡½å¼ã€‘å°‡æ‘˜è¦çµæœæ¸²æŸ“ç‚ºæ©«å‘è¡¨æ ¼
  function renderSummary(data, res, years){
    const head1 = $('#summaryTable1 thead');
    const body1 = $('#summaryTable1 tbody');
    const head2 = $('#summaryTable2 thead');
    const body2 = $('#summaryTable2 tbody');
    head1.innerHTML = '';
    body1.innerHTML = '';
    head2.innerHTML = '';
    body2.innerHTML = '';
    
    // 1. æº–å‚™æ•¸æ“šå’Œæ¨£å¼
    const liqClass = res.liquidated ? 'bad' : 'ok'; // for traffic light
    const roiClass = res.roi > 0 ? 'data-ok' : (res.roi < 0 ? 'data-bad' : '');
    
    // 1.1 Table 1: åŸºæœ¬çµ±è¨ˆèˆ‡ç‹€æ…‹
    const metrics1Keys = ['æ¨£æœ¬ç­†æ•¸', 'å€é–“', 'é€²å ´æ¬¡æ•¸', 'å‡ºå ´æ¬¡æ•¸', 'æ˜¯å¦çˆ†å€‰'];
    const metrics1Values = [
        data.length || 'â€”',
        data.length ? (iso(data[0].date)+' â†’ '+iso(data[data.length-1].date)+'ï¼ˆè¿‘ '+years+' å¹´ï¼‰') : 'â€”',
        res.nEntry,
        res.nExit,
        // ç‡ˆè™Ÿé¡¯ç¤º
        `<span class="traffic-light ${liqClass}"></span> ${res.liquidated ? 'çˆ†å€‰' : 'å®‰å…¨'}` 
    ];
    
    // 1.2 Table 2: è²¡å‹™ç¸¾æ•ˆ
    const metrics2Keys = ['æœŸæœ«æ·¨å€¼ (USD)', 'ROIï¼ˆä¿è­‰é‡‘ï¼‰', 'æœ€å¤§å›æ’¤ï¼ˆä¿è­‰é‡‘ï¼‰', 'æœŸæœ«å®‰å…¨é‚Šéš›'];
    const metrics2Values = [
        fmt(res.equityEnd, 2),
        (res.roi == null) ? 'â€”' : (res.roi * 100).toFixed(2) + '%',
        (res.mddPct != null) ? res.mddPct.toFixed(2) + '%' : 'â€”',
        (res.safetyEnd != null) ? res.safetyEnd.toFixed(2) + '%' : 'â€”'
    ];
    const metrics2Classes = ['', roiClass, 'data-bad', '']; // MDD å±¬æ–¼é¢¨éšªæŒ‡æ¨™ï¼Œæš«å®šç‚º data-bad

    // 2. æ¸²æŸ“ Table 1
    let head1Html = '<tr>';
    metrics1Keys.forEach(key => { head1Html += `<th>${key}</th>`; });
    head1Html += '</tr>';
    head1.innerHTML = head1Html;

    let body1Html = '<tr>';
    metrics1Values.forEach(value => { body1Html += `<td>${value}</td>`; });
    body1Html += '</tr>';
    body1.innerHTML = body1Html;
    
    // 3. æ¸²æŸ“ Table 2
    let head2Html = '<tr>';
    metrics2Keys.forEach(key => { head2Html += `<th>${key}</th>`; });
    head2Html += '</tr>';
    head2.innerHTML = head2Html;

    let body2Html = '<tr>';
    metrics2Values.forEach((value, index) => { 
        const styleClass = metrics2Classes[index] || '';
        body2Html += `<td class="${styleClass}">${value}</td>`; 
    });
    body2Html += '</tr>';
    body2.innerHTML = body2Html;
    
    // 4. æ¸²æŸ“ AI å»ºè­°
    renderAISuggestion(res, data.length > 0 ? (data[data.length-1].date - data[0].date) / (365.25 * 24 * 60 * 60 * 1000) : 1);
  }

 // ã€ä¿®æ­£äº‚ç¢¼å¾Œçš„å‡½å¼ï¼šä½¿ç”¨æ¨™æº–ç¬¦è™Ÿå’Œæ›´æ¸…æ™°çš„æ’ç‰ˆã€‘
  function renderAISuggestion(res, totalYears){
    const container = $('#aiAdviceContent');
    // ç²å–ç•¶å‰åƒæ•¸
    const margin = Number($('#margin').value);
    const lev = Number($('#lev').value);
    const lot = Number($('#lot').value);
    const entryPullback = Number($('#entryPullback').value);
    const exitDrawdown = Number($('#exitDrawdown').value);
    const entryLookback = Number($('#entryLookback').value);
    
    // é—œéµæŒ‡æ¨™ï¼ˆç™¾åˆ†æ¯”å½¢å¼ï¼‰
    const roiPct = res.roi * 100;
    const mddPct = res.mddPct;
    
    // è¨ˆç®— Calmar Ratio (å¹´åŒ–å ±é…¬ / æœ€å¤§å›æ’¤)
    const annualRoiPct = (totalYears > 0 && isFinite(totalYears)) ? roiPct / totalYears : roiPct;
    // Calmar Ratio: é¢¨éšªèª¿æ•´å¾Œå ±é…¬ (Risk-Adjusted Return)ï¼Œæ¯”å€¼è¶Šé«˜è¶Šå¥½
    const calmarRatio = (mddPct > 0) ? (annualRoiPct / mddPct) : (roiPct > 0 ? Infinity : 0);

    const nEntry = res.nEntry;
    const dataLength = lastData ? lastData.length : 0;
    
    let adviceType = 'ğŸ’¡ ä¸­æ€§è§€å¯Ÿ';
    let adviceClass = 'warn';
    let summary = '';
    let suggestions = [];
    
    // --- é‚è¼¯åˆ¤æ–·å€ ---
    
    // æ¢ä»¶ 1: çˆ†å€‰/é«˜é¢¨éšª (MDD = 100% / ROI = -100%)
    if (res.liquidated) {
        adviceType = 'ğŸš¨ è‡´å‘½é¢¨éšªï¼šå·²çˆ†å€‰';
        adviceClass = 'bad';
        summary = `æ‚¨çš„ç­–ç•¥åœ¨æœ¬æ¬¡å›æ¸¬ä¸­**å·²çˆ†å€‰**ï¼Œè¡¨ç¤ºç¾æœ‰è³‡é‡‘å’Œæ§“æ¡¿é…ç½®çš„é¢¨éšªé è¶…å¸‚å ´æ³¢å‹•æ‰¿å—èƒ½åŠ›ã€‚`;
        suggestions.push(`ç•¶å‰æ§“æ¡¿ **${lev} å€** å¤±æ•—ã€‚æ‡‰ç«‹å³å°‡**æ§“æ¡¿é™è‡³ ${Math.max(1, Math.floor(lev * 0.5))} å€ä»¥ä¸‹**ï¼Œç›´åˆ°ç­–ç•¥ç©©å®šã€‚`);
        suggestions.push(`å¼·çƒˆå»ºè­°å•Ÿç”¨**å®‰å…¨é‚Šéš›**ä¸¦å°‡**å›ºå®šä¿è­‰é‡‘ (Margin)** æé«˜åˆ°è‡³å°‘ ${fmt(margin * 1.5, 0)} USDã€‚`);
    } 
    // æ¢ä»¶ 2: è¡¨ç¾å„ªç•° (Calmar Ratio > 1.5 ä¸” ROI > 15%)
    else if (calmarRatio > 1.5 && roiPct > 15) {
        adviceType = 'ğŸŒŸ ç¸¾æ•ˆå¼·å‹ / é«˜æ•ˆèƒ½';
        adviceClass = 'ok';
        summary = `ç­–ç•¥è¡¨ç¾å¼·å‹ä¸”é¢¨éšªèª¿æ•´å¾Œå ±é…¬ï¼ˆ**Calmar Ratio ${calmarRatio.toFixed(2)}**ï¼‰å„ªç•°ï¼Œé¡¯ç¤ºç­–ç•¥åœ¨å‰µé€ å ±é…¬çš„åŒæ™‚ï¼Œèƒ½æœ‰æ•ˆæ§åˆ¶æœ€å¤§å›æ’¤ã€‚`;
        suggestions.push(`å¯å˜—è©¦åœ¨ç•¶å‰æ§“æ¡¿ä¸‹ï¼Œ**æé«˜å–®æ¬¡é€²å ´åç›® (LOT)** ç´„ 10-20% (ä¾‹å¦‚ ${fmt(lot * 1.15, 0)} USD) é€²è¡Œå†æ¬¡å›æ¸¬ã€‚`);
        suggestions.push('å»ºè­°ä¿ç•™**å‡ºå ´åƒ¹ä½æ–¼å€‰ä½å‡åƒ¹ä¸å‡ºå ´**çš„é™åˆ¶ï¼Œä»¥ç¶­æŒä½å›æ’¤å„ªå‹¢ã€‚');
    } 
    // æ¢ä»¶ 3: é«˜é¢¨éšªä½å ±é…¬ (MDD > 30% ä¸” Calmar Ratio < 0.5)
    else if (mddPct > 30 && calmarRatio < 0.5) {
        adviceType = 'âš ï¸ é«˜å›æ’¤ / ä½æ•ˆèƒ½';
        adviceClass = 'bad';
        summary = `æœ€å¤§å›æ’¤é«˜é” **${mddPct.toFixed(2)}%** ä¸”é¢¨éšªèª¿æ•´å¾Œå ±é…¬ï¼ˆCalmar Ratioï¼‰ä½æ–¼ 0.5ï¼Œç­–ç•¥é¢¨éšªéé«˜ã€‚`;
        suggestions.push(`å»ºè­°**æé«˜å…¥å ´å›æª”è§¸ç™¼ (%)** (ä¾‹å¦‚ ${Math.min(30, entryPullback + 5)}%) ä»¥ç¢ºä¿è²·åœ¨æ·±è·Œã€‚`);
        suggestions.push('æ‡‰æª¢æŸ¥å‡ºå ´æ¢ä»¶ï¼Œå¯èƒ½éœ€è¦**é™ä½å‡ºå ´å›è½è§¸ç™¼ (%)** ä¾†æ›´æ—©åœ°æ­¢ææˆ–é–åˆ©ã€‚');
        suggestions.push('è€ƒæ…®**é™ä½å–®æ¬¡é€²å ´åç›® (LOT)**ï¼Œé™ä½å–®æ¬¡è™§æçš„å½±éŸ¿ã€‚');
    }
    // æ¢ä»¶ 4: æ½›åœ¨æ¼æ¥æ©Ÿæœƒ (é€²å ´æ¬¡æ•¸éå°‘)
    else if (nEntry < Math.max(5, dataLength / 180)) { // æ¯åŠå¹´ä¸åˆ° 2 æ¬¡ï¼Œè¦–ç‚ºéå°‘
        adviceType = 'ğŸŸ¡ äº¤æ˜“é »ç‡ä½';
        adviceClass = 'warn';
        summary = 'ç­–ç•¥å¯èƒ½éæ–¼ä¿å®ˆï¼Œé€²å ´æ¬¡æ•¸éå°‘ï¼ŒéŒ¯å¤±äº†æ½›åœ¨çš„äº¤æ˜“æ©Ÿæœƒã€‚';
        suggestions.push(`å˜—è©¦**ç¸®çŸ­æ»¾å‹•é«˜é»è¦–çª—ï¼ˆé€²å ´ï¼‰** (ä¾‹å¦‚ ${Math.max(30, entryLookback - 30)} å¤©) ä¾†æ”¾å¯¬å…¥å ´é™åˆ¶ã€‚`);
        suggestions.push(`æˆ–**é™ä½å›æª”è§¸ç™¼ (%)** (ä¾‹å¦‚ ${Math.max(5, entryPullback - 5)}%) ä¾†æé«˜é€²å ´æ¬¡æ•¸ã€‚`);
    }
    // æ¢ä»¶ 5: ä¸­ç­‰è¡¨ç¾/éœ€è¦å¾®èª¿ (é©ç”¨æ–¼æ‚¨æä¾›çš„ç¯„ä¾‹çµæœ)
    else {
        // é©ç”¨æ–¼ ROI 599.72%, Calmar Ratio 1.45 (ä¸­ç­‰åä¸Š)
        adviceType = 'ğŸ’¡ ä¸­ç­‰ç©©å¥ / å„ªåŒ–ç©ºé–“';
        adviceClass = 'warn';
        summary = `ç›®å‰ç¸½å ±é…¬ **${roiPct.toFixed(2)}%** è¡¨ç¾è‰¯å¥½ï¼Œä½†é¢¨éšªèª¿æ•´å¾Œå ±é…¬ï¼ˆCalmar Ratio ${calmarRatio.toFixed(2)}ï¼‰åœ¨ 1.5 é™„è¿‘ï¼Œä»æœ‰æå‡ç©ºé–“ã€‚`;
        
        // æ ¸å¿ƒå»ºè­°æ’ç‰ˆ
        suggestions.push(`**ã€ç­–ç•¥å¹³è¡¡ã€‘**å»ºè­°ç¢ºä¿ **å…¥å ´å›æª” (${entryPullback}%) å¤§æ–¼ç­‰æ–¼ (>=) å‡ºå ´å›è½ (${exitDrawdown}%)**ï¼Œä»¥ç¢ºä¿æœ‰è¶³å¤ çš„æµ®ç›ˆç©ºé–“ä¾†æ‡‰å°å›è½è§¸ç™¼ï¼Œæ¸›å°‘å‡è¨Šè™Ÿã€‚`);
        suggestions.push(`**ã€é™ä½æ³¢å‹•ã€‘**è‹¥å¸Œæœ›é™ä½æ³¢å‹•ï¼Œè«‹æª¢æŸ¥ **ã€Œå‡ºå ´åƒ¹ä½æ–¼å€‰ä½å‡åƒ¹ä¸å‡ºå ´ã€** æ˜¯å¦å•Ÿç”¨ã€‚æ­¤é™åˆ¶æœ‰åŠ©æ–¼**æ§åˆ¶æœ€å¤§å›æ’¤ (MDD)**ã€‚`);
        suggestions.push(`**ã€æŒçºŒæ¸¬è©¦ã€‘**å»ºè­°å°ˆæ³¨æ–¼å–®ä¸€åƒæ•¸çš„å¾®èª¿ï¼ˆä¾‹å¦‚èª¿æ•´å…¥å ´å›æª” **+/- 5%**ï¼‰ï¼Œè§€å¯Ÿ Calmar Ratio çš„è®ŠåŒ–ã€‚`);
    }

    // æ¸²æŸ“çµæœ
    let html = `
        <div class="advice-type ${adviceClass}">ã€${adviceType}ã€‘</div>
        <p style="margin-top: 5px; margin-bottom: 5px; font-size: 13px; color: var(--text);">${summary}</p>
        <h5 style="font-size: 13px; color: var(--gold-soft); margin: 10px 0 5px;">å…·é«”è¡Œå‹•å»ºè­°ï¼š</h5>
        <ul>
            ${suggestions.map(s => `<li>${s}</li>`).join('')}
        </ul>
    `;
    container.innerHTML = html;
  }


  function renderEntriesTable(list){
    const head=$('#entriesTable thead tr'), body=$('#entriesTable tbody'); head.innerHTML=''; body.innerHTML='';
    const cols=['é¡å‹','æ—¥æœŸ','åƒ¹æ ¼','åƒè€ƒé«˜é»','åƒè€ƒé«˜é»æ—¥æœŸ','è§¸ç™¼åƒ¹','åç›®éƒ¨ä½USD','å€‰ä½å‡åƒ¹','æŒå€‰åƒ¹å€¼USD','å‡ºå ´æ¯”ä¾‹%','ROI(USDT)','ROI(%)','å€‰ä½æ§“æ¡¿å€æ•¸Ã—'];
    cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; head.appendChild(th); });
    list.forEach(r=>{
      const tr=document.createElement('tr');
      const levx = (r.å€‰ä½æ§“æ¡¿å€æ•¸!=null && isFinite(r.å€‰ä½æ§“æ¡¿å€æ•¸))? r.å€‰ä½æ§“æ¡¿å€æ•¸: null;
      [ r.é¡å‹, iso(r.æ—¥æœŸ), fmt(r.åƒ¹æ ¼,2), fmt(r.åƒè€ƒé«˜é»,2), (r.åƒè€ƒé«˜é»æ—¥æœŸ? iso(r.åƒè€ƒé«˜é»æ—¥æœŸ): 'â€”'), fmt(r.è§¸ç™¼åƒ¹,2), fmt(r.åç›®éƒ¨ä½USD,0), fmt(r.å€‰ä½å‡åƒ¹,2), fmt(r.æŒå€‰åƒ¹å€¼USD,0), (r.å‡ºå ´æ¯”ä¾‹!=null? r.å‡ºå ´æ¯”ä¾‹+'%':'â€”'), fmt(r.ROI_USDT,2), (r.ROI_PCT!=null? r.ROI_PCT.toFixed(2)+'%':'â€”'), (levx==null?'â€”':fmt(levx,2)) ]
        .forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
      body.appendChild(tr);
    });
  }
  
  // è™•ç†å¾Œè·¯å¾‘è¡¨æ ¼å·²è¢«ç§»é™¤
  // function renderPathTable(path){ ... }

  function renderChart(data, entries, path){
    if(typeof Chart==='undefined') return; const ctx=$('#chart').getContext('2d');
    const labels=data.map(x=> iso(x.date)); const price=data.map(x=> x.close);
    const avgLine=path.map(x=> isNaN(x.avg_price)? null: x.avg_price);
    const liqLine=path.map(x=> (x&&x.liq_price!=null)? x.liq_price: null);
    const labelsEntries = entries.map(e=> iso(e.æ—¥æœŸ));
    const entryY   = entries.map(e=> e.åƒ¹æ ¼);
    const entryFlags = entries.map(e=> e.é¡å‹.startsWith('é€²å ´'));
    const exitFlags  = entries.map(e=> e.é¡å‹.startsWith('å›è½è§¸ç™¼') || e.é¡å‹.startsWith('è·Œç ´å‰é«˜') || e.é¡å‹.startsWith('å¼·åˆ¶å…¨å‡º'));

    const idxEntry = labelsEntries.map(t=> labels.indexOf(t));
    const scatterEntry = labels.map((_,i)=>{ const j=idxEntry.indexOf(i); return (j>=0 && entryFlags[j])? entryY[j]: null; });
    const scatterExit  = labels.map((_,i)=>{ const j=idxEntry.indexOf(i); return (j>=0 && exitFlags[j])? entryY[j]: null; });

    if(chart) chart.destroy();
    chart = new Chart(ctx,{
      type:'line', data:{ labels,
        datasets:[
          { label:'æ”¶å¸‚', data:price, pointRadius:0, borderColor:cPrice },
          { label:'åŠ æ¬Šå¹³å‡åƒ¹', data:avgLine, borderDash:[6,4], pointRadius:0, borderColor:cAvg },
          { label:'çˆ†å€‰ç·šï¼ˆå‹•æ…‹ï¼‰', data:liqLine, borderDash:[2,2], pointRadius:0, borderColor:cLiq },
          { label:'é€²å ´é»', type:'scatter', data:scatterEntry, showLine:false, pointRadius:4, borderColor:cEntry, backgroundColor:cEntry },
          { label:'å‡ºå ´é»', type:'scatter', data:scatterExit,  showLine:false, pointRadius:4, borderColor:cExit,  backgroundColor:cExit }
        ] },
      options:{ responsive:true, resizeDelay:200, animation:false,
        interaction:{mode:'index',intersect:false},
        plugins:{ legend:{position:'top', labels:{color:'#EDEFF5'}}, tooltip:{callbacks:{label:(c)=> c.dataset.label+': '+fmt(c.parsed.y,2)}} },
        scales:{ x:{ticks:{color:'#C9D3EA',maxRotation:0,autoSkip:true,maxTicksLimit:12}, grid:{color:'rgba(233,209,138,.12)'}}, y:{beginAtZero:false, ticks:{color:'#C9D3EA'}, grid:{color:'rgba(233,209,138,.12)'}} }
      }
    });
  }

  function computeIfReady(){
    if(!df||!df.length){ uiLog('å·²é¸æª”ï¼Œä½†æ²’æœ‰æœ‰æ•ˆè³‡æ–™åˆ—'); return; }
    const years = Number($('#years').value);
    const entLb = Number($('#entryLookback').value);
    const entPB = Number($('#entryPullback').value)/100;
    const extLb = Number($('#exitLookback').value);
    const extDD = Number($('#exitDrawdown').value)/100;
    const extPct= Number($('#exitSellPct').value);
    const lev   = Number($('#lev').value);
    const margin= Number($('#margin').value);
    const lot   = Number($('#lot').value);
    const mpq   = Number($('#maxPerQ').value);
    const maxExitPerQ = Number($('#maxExitPerQ').value);
    const exitNonNegRoi = $('#exitNonNegRoi').checked;
    const exitAboveAvgOnly = $('#exitAboveAvgOnly').checked;
    const safetyOn = $('#safetyMode').value==='on';
    const safetyFloor = Number($('#safetyFloor').value);

    // è‡ªå‹•æ›´æ–°æ»¿å€‰ä¸Šé™é¡¯ç¤º
    $('#maxNotional').value = (lev*margin).toFixed(0);

    const cut = filterYears(df, years); if(!cut.length){ uiLog('æœŸé–“å…§æ²’æœ‰è³‡æ–™'); return; }
    const res = simulate(cut, {
      entryLookback: entLb,
      entryPullback: entPB,
      exitLookback: extLb,
      exitDrawdown: extDD,
      exitSellPct: extPct,
      leverage: lev,
      margin: margin,
      lotUSD: lot,
      maxPerQuarter: mpq,
      exitMaxPerQuarter: maxExitPerQ,
      exitNonNegRoi: exitNonNegRoi,
      exitAboveAvgOnly: exitAboveAvgOnly,
      safetyOn: safetyOn,
      safetyFloorPct: safetyFloor
    });

    lastRes=res; lastData=cut; lastYears=years;
    // æ¸²æŸ“ Summary Table (æ–°) å’Œ Entries Table (èˆŠ)
    renderSummary(cut,res,years); 
    renderEntriesTable(res.entries); 
    renderChart(cut,res.entries,res.path);
    
    uiLog(`å®Œæˆï¼šé€²å ´ ${res.nEntry} æ¬¡ã€å‡ºå ´ ${res.nExit} æ¬¡${res.liquidated?'ï¼ˆå·²çˆ†å€‰ï¼‰':''}ï¼›æ¨£æœ¬ ${cut.length} ç­†`);
    $('#exportEntries').disabled = res.entries.length===0; $('#exportSummary').disabled = false;
    // å›æ¸¬å®Œæˆå¾Œå•Ÿç”¨ä¸‹è¼‰ PNG æŒ‰éˆ•
    $('#exportChartPng').disabled = false;
  }

  // åŒ¯å‡º
  function exportEntriesCSV(){ if(!lastRes) return; const rows=lastRes.entries; const csv=toCSV(rows,
      ['é¡å‹','æ—¥æœŸ','åƒ¹æ ¼','åƒè€ƒé«˜é»','åƒè€ƒé«˜é»æ—¥æœŸ','è§¸ç™¼åƒ¹','åç›®éƒ¨ä½USD','å€‰ä½å‡åƒ¹','æŒå€‰åƒ¹å€¼USD','å‡ºå ´æ¯”ä¾‹','ROI_USDT','ROI_PCT','å€‰ä½æ§“æ¡¿å€æ•¸'],
      ['type','date','price','ref_high','ref_high_date','trigger_price','notional_usd','avg_price','position_value_usd','exit_ratio_pct','roi_usdt','roi_pct','lev']
    ); downloadCSV('entries.csv', csv); }
  function exportSummaryCSV(){ if(!lastRes) return; const r=lastRes; const csv=toCSV([{ samples:lastData?.length||0, range:(lastData?.length? iso(lastData[0].date)+' â†’ '+iso(lastData[lastData.length-1].date):''), entries:r.nEntry, exits:r.nExit, liquidated:r.liquidated?'Y':'N', equity_end:r.equityEnd, roi_pct:r.roi*100, mdd_pct:r.mddPct, safety_end_pct:r.safetyEnd }], ['samples','range','entries','exits','liquidated','equity_end','roi_pct','mdd_pct','safety_end_pct'], ['samples','range','entries','exits','liquidated','equity_end','roi(%)','mdd(%)','safety_end(%)']); downloadCSV('summary.csv', csv); }

  // === æ‘ºç–Šé¢æ¿é‚è¼¯ ===
  function setupCollapsible(id) {
    const header = document.querySelector(`.collapsible-header[data-target="${id}"]`);
    const content = document.getElementById(id);

    if (!header || !content) return;

    // åˆå§‹ç‹€æ…‹ï¼šå±•é–‹
    // å»¶é²è¨­å®š max-height æ‰èƒ½è®“ transition workï¼Œå¦å‰‡æœƒåœ¨è¼‰å…¥æ™‚ç¬é–“å±•é–‹
    setTimeout(() => {
        content.style.maxHeight = content.scrollHeight + 'px';
    }, 50); 
    
    header.addEventListener('click', () => {
        const isCollapsed = header.classList.contains('collapsed');
        header.classList.toggle('collapsed');
        if (isCollapsed) {
            // å±•é–‹
            content.style.maxHeight = content.scrollHeight + 'px';
        } else {
            // æ‘ºç–Š
            content.style.maxHeight = '0';
        }
    });
  }

  // ç¶äº‹ä»¶
  $('#file').addEventListener('change', async (e)=>{ const f=e.target.files&&e.target.files[0]; if(!f){ uiLog('æ²’æœ‰æ”¶åˆ°æª”æ¡ˆ'); return; } uiLog(`æª”åï¼š${f.name}ï¼Œå¤§å°ï¼š${f.size}ï¼Œè®€å–ä¸­â€¦`); try{ const rows=await readAnyTabular(f); uiLog('å·²è®€å– '+rows.length+' è¡Œï¼Œè§£æä¸­â€¦'); df=parseRows(rows); uiLog('å·²è§£æ '+df.length+' ç­†ï¼ˆ'+iso(df[0].date)+' â†’ '+iso(df[df.length-1].date)+'ï¼‰ï¼Œè¨ˆç®—ä¸­â€¦'); computeIfReady(); }catch(err){ console.error(err); uiLog('éŒ¯èª¤ï¼š'+(err.message||err)); alert(err.message||err); } });
  let debounce=null; ['years','entryLookback','entryPullback','exitLookback','exitDrawdown','exitSellPct','lev','margin','lot','maxPerQ','maxExitPerQ','exitNonNegRoi','exitAboveAvgOnly','safetyFloor','safetyMode']
    .forEach(id=>{ document.getElementById(id).addEventListener('input',()=>{ clearTimeout(debounce); debounce=setTimeout(()=>{ if(df) computeIfReady(); refreshLiveDaily(); },150); }); });
  $('#exportEntries').addEventListener('click', exportEntriesCSV);
  $('#exportSummary').addEventListener('click', exportSummaryCSV);
  $('#exportChartPng').addEventListener('click', exportChartPng); 

  // å³æ™‚åœ–ï¼šåˆå§‹èˆ‡æ§åˆ¶ç¶å®š
  async function initLive(){ await refreshLiveDaily(); startBinanceWS(); bindLiveAutoRefresh(); }
  
  document.addEventListener('DOMContentLoaded', () => {
    // é è¨­å±•é–‹é¢¨æ§å’Œè³‡é‡‘åƒæ•¸
    setupCollapsible('controlRisk');
    setupCollapsible('controlFund'); 
    initLive();
  });
  

  // å³ä¸Šå³æ™‚åœ–èˆ‡å·¦å´é€²/å‡ºå ´è¨­å®šåŒæ­¥
  $('#entryLookback').addEventListener('change', refreshLiveDaily);
  $('#entryPullback').addEventListener('input', refreshLiveDaily);
  $('#exitLookback').addEventListener('change', refreshLiveDaily);
  $('#exitDrawdown').addEventListener('input', refreshLiveDaily);
</script>
</body>
</html>
